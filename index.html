<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SynqBrand Customer Portal</title>
    <link href="https://releases.transloadit.com/uppy/v3.3.1/uppy.min.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 1rem; box-sizing: border-box; }
        .container { background: white; padding: 2rem 2.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 900px; text-align: center; }
        h1, h2 { color: #1c1e21; margin-top: 0; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; text-align: left; }
        label { display: block; margin-bottom: 0.5rem; color: #606770; font-weight: 600; }
        label.required::after { content: ' *'; color: #d9534f; }
        input[type="text"], input[type="password"], textarea { width: 100%; padding: 0.8rem; border: 1px solid #dddfe2; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        textarea { resize: vertical; min-height: 120px; }
        #status { margin-top: 1.5rem; font-weight: bold; min-height: 20px; }
        #post-status { margin-top: 1.5rem; text-align: left; min-height: 20px; line-height: 1.6; }
        .error { color: #d9534f; }
        .success { color: #5cb85c; }
        #uppy-drag-drop-area .uppy-Dashboard-inner { border: 2px dashed #dddfe2; }
        .btn-primary, .btn-secondary { width: 100%; padding: 0.8rem; border-radius: 6px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.2s ease-in-out; margin-top: 1rem; border: 2px solid; background-color: transparent; }
        .btn-primary { border-color: #4A90E2; color: #4A90E2; }
        .btn-primary:not(:disabled):hover { background-color: #4A90E2; color: white; }
        .btn-secondary { border-color: #6c757d; color: #6c757d; }
        .btn-secondary:not(:disabled):hover { background-color: #6c757d; color: white; }
        .btn-primary:disabled, .btn-secondary:disabled { border-color: #ccc; color: #ccc; background-color: #f8f8f8; cursor: not-allowed; }
        .panel-buttons { display: flex; flex-direction: column; gap: 0.5rem; }
        .status-block { border: 1px solid; border-radius: 8px; padding: 1.25rem; margin-top: 1rem; }
        .status-block h4 { margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem; font-weight: 600; }
        .status-block p { margin: 0; line-height: 1.5; }
        .status-block ul { list-style-type: none; padding: 0; margin: 0; }
        .status-block li { display: flex; align-items: center; padding: 0.4rem 0; }
        .status-icon { width: 20px; height: 20px; margin-right: 12px; }
        .status-success { background-color: #e7f5ff; border-color: #b3d9ff; color: #004085; }
        .icon-success { color: #28a745; }
        .status-error { background-color: #fdecea; border-color: #f5c6cb; color: #721c24; }
        .status-error h4 { text-transform: uppercase; }
        .icon-error { color: #dc3545; }
        .platform-options { display: flex; flex-direction: column; gap: 0.5rem; }
        .checkbox-wrapper { display: inline-flex; align-items: center; cursor: pointer; user-select: none; }
        .checkbox-wrapper input[type="checkbox"] { display: none; }
        .checkbox-wrapper .checkbox-label { display: flex; align-items: center; }
        .checkbox-wrapper .checkbox-custom { width: 20px; height: 20px; border: 2px solid #dddfe2; border-radius: 4px; margin-right: 10px; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .checkbox-wrapper .checkbox-label-text { font-weight: 500; color: #333; }
        .checkbox-wrapper input[type="checkbox"]:checked + .checkbox-label .checkbox-custom { background-color: #4A90E2; border-color: #4A90E2; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: center; background-size: 60%; }
        .select-all-wrapper { padding-bottom: 1rem; border-bottom: 1px solid #eee; margin-bottom: 1rem; }
        .select-all-wrapper .checkbox-label-text { font-weight: 700; }
        #platform-selection-container { display: flex; flex-wrap: wrap; gap: 1.5rem; padding-top: 0.5rem; }

        /* GALERİ STİLLERİ */
        #approval-gallery-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1.5rem; margin-top: 2rem; margin-bottom: 2rem; text-align: left; }
        .gallery-card { border: 1px solid #dddfe2; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .gallery-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .gallery-card img { width: 100%; height: 220px; object-fit: cover; background-color: #f0f2f5; }
        .gallery-card-content { padding: 1rem; }
        .gallery-card-content p { margin: 0; font-size: 0.95rem; color: #333; line-height: 1.4; }
        .loading-text, .empty-text { grid-column: 1 / -1; text-align: center; color: #606770; padding: 3rem 0; font-size: 1.1rem; }
        
        /* GÜNCELLENMİŞ MODAL STİLLERİ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; padding: 1rem; box-sizing: border-box; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: white; border-radius: 8px; width: 100%; max-width: 850px; display: flex; flex-direction: column; max-height: 95vh; text-align: left; transform: scale(0.9); transition: transform 0.3s ease; overflow: hidden; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-header { padding: 1.5rem 2rem; border-bottom: 1px solid #eee; position: relative; }
        .modal-header h3 { margin: 0; font-size: 1.3rem; line-height: 1.4; padding-right: 3rem; }
        .modal-close-btn { position: absolute; top: 50%; right: 1.5rem; transform: translateY(-50%); background: none; border: none; font-size: 2.5rem; cursor: pointer; color: #888; line-height: 1; padding: 0; }
        
        .modal-body-grid { display: grid; grid-template-columns: 300px 1fr; gap: 2rem; padding: 1.5rem 2rem; overflow-y: auto; }
        .modal-visual-column { position: sticky; top: 0; align-self: start; }
        .modal-visual-column img { width: 100%; border-radius: 6px; }
        
        .modal-platforms-column h4 { margin-top: 0; margin-bottom: 1rem; color: #333; }
        
        /* AKORDİYON STİLLERİ */
        .accordion-item { border-bottom: 1px solid #eee; }
        .accordion-item:last-child { border-bottom: none; }
        .accordion-header { background: #fff; cursor: pointer; padding: 1rem 0; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #1c1e21; }
        .accordion-header::after { content: '▼'; font-size: 0.8rem; transition: transform 0.2s ease; }
        .accordion-item.active .accordion-header::after { transform: rotate(180deg); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; }
        .accordion-item.active .accordion-content { max-height: 1000px; padding-bottom: 1.5rem; }
        
        .content-section { margin-bottom: 1rem; }
        .content-section h5 { margin: 0 0 0.5rem 0; font-size: 0.8rem; color: #606770; text-transform: uppercase; }
        .content-text, .content-hashtags { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 1rem; white-space: pre-wrap; line-height: 1.6; font-size: 0.95rem; }
        .content-hashtags { color: #4A90E2; word-break: break-word; }
        
        .approval-buttons { display: flex; gap: 1rem; margin-top: 1rem; }
        .btn-decision { flex-grow: 1; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.6rem; font-size: 0.9rem; border-width: 2px; }
        .btn-approve { border-color: #28a745; color: #28a745; }
        .btn-approve:not(.disabled):hover { background-color: #28a745; color: white; }
        .btn-reject { border-color: #dc3545; color: #dc3545; }
        .btn-reject:not(.disabled):hover { background-color: #dc3545; color: white; }

        .btn-decision.approved { background-color: #28a745; color: white; border-color: #28a745;}
        .btn-decision.rejected { background-color: #dc3545; color: white; border-color: #dc3545;}
        .btn-decision.disabled { border-color: #ccc !important; color: #ccc !important; background-color: #f8f8f8 !important; cursor: not-allowed; }

        @media (max-width: 768px) {
            .modal-content { max-width: 100%; max-height: 90vh;}
            .modal-body-grid { grid-template-columns: 1fr; }
            .modal-visual-column { position: static; margin-bottom: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="login-section"><h1>Portal Login</h1><form id="login-form"><div class="form-group"><label for="username">Username</label><input type="text" id="username" required></div><div class="form-group"><label for="password">Password</label><input type="password" id="password" required></div><button type="submit" id="login-btn" class="btn-primary">Log In</button></form><div id="status"></div></div>
        <div id="customer-panel" style="display:none;"><h1>Customer Panel</h1><p id="welcome-message"></p><div class="panel-buttons"><button id="show-form-btn" class="btn-primary">Create New Post</button><button id="show-approval-portal-btn" class="btn-primary">Pending Monthly Posts</button><button id="logout-btn" class="btn-secondary">Log Out</button></div></div>
        <div id="post-form-section" style="display:none;"><h2>Create New Post</h2><form id="post-form"><div class="form-group"><label for="postTitle" class="required">Title</label><input type="text" id="postTitle" required></div><div class="form-group"><label for="postContent" class="required">Content / Caption</label><textarea id="postContent" required></textarea></div><div class="form-group"><label for="destinationLink">Destination Link</label><input type="text" id="destinationLink" placeholder="https://example.com"></div><div class="form-group"><label class="required">Media Files</label><div id="uppy-drag-drop-area"></div></div><div class="form-group"><label class="required">Select Platforms to Post</label><div class="platform-options"><div class="checkbox-wrapper select-all-wrapper"><input type="checkbox" id="select-all-platforms" disabled><label for="select-all-platforms" class="checkbox-label"><span class="checkbox-custom"></span><span class="checkbox-label-text">Select / Deselect All</span></label></div><div id="platform-selection-container"><p><em>Loading available platforms...</em></p></div></div></div><button type="submit" id="submit-post-btn" class="btn-primary">Submit Post</button><button type="button" id="back-to-panel-btn" class="btn-secondary">Back to Panel</button></form><div id="post-status"></div></div>
        <div id="approval-portal-section" style="display:none;"><h2>Pending Monthly Posts</h2><div id="approval-gallery-container"></div><button type="button" id="back-to-panel-from-approval-btn" class="btn-secondary">Back to Panel</button></div>
    </div>
    
    <div class="modal-overlay" id="approval-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Review Post</h3>
                <button class="modal-close-btn" id="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body-grid">
                <div class="modal-visual-column">
                    <img id="modal-visual" src="" alt="Post Visual">
                </div>
                <div class="modal-platforms-column" id="modal-platforms"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { Uppy, Dashboard, AwsS3 } from "https://releases.transloadit.com/uppy/v3.3.1/uppy.min.mjs";

        const LOGIN_WORKFLOW_URL = 'https://ops.synqbrand.com/webhook/auth/login';
        const PRESIGNER_API_URL = 'https://presigner.synqbrand.com/generate-presigned-url';
        const MAIN_POST_WORKFLOW_URL = 'https://ops.synqbrand.com/webhook/70c27eca-bdc5-46bb-897b-13c3cd27bb8d';
        const STATUS_CHECK_BASE_URL = 'https://ops.synqbrand.com/webhook/b21a7415-3fd1-41a4-905f-4718a2205852/check-status/';
        const R2_PUBLIC_BASE_URL = 'https://media.izmirarkadas.com';
        const GET_PLATFORMS_URL = 'https://ops.synqbrand.com/webhook/e3b4673c-d346-4f09-a970-052526b6646e';
        const GET_PENDING_POSTS_URL = 'https://ops.synqbrand.com/webhook/ac5496d2-7540-4db1-b7e1-a28c0e2320dc';

        let state = { loadingIntervalId: null, pendingPosts: [] };

        const loginSection = document.getElementById('login-section'); const customerPanel = document.getElementById('customer-panel'); const postFormSection = document.getElementById('post-form-section'); const loginForm = document.getElementById('login-form'); const loginBtn = document.getElementById('login-btn'); const statusDiv = document.getElementById('status'); const welcomeMessage = document.getElementById('welcome-message'); const showFormBtn = document.getElementById('show-form-btn'); const postForm = document.getElementById('post-form'); const submitPostBtn = document.getElementById('submit-post-btn'); const postStatusDiv = document.getElementById('post-status'); const backToPanelBtn = document.getElementById('back-to-panel-btn'); const logoutBtn = document.getElementById('logout-btn'); const approvalPortalSection = document.getElementById('approval-portal-section'); const showApprovalPortalBtn = document.getElementById('show-approval-portal-btn'); const backToPanelFromApprovalBtn = document.getElementById('back-to-panel-from-approval-btn'); const approvalGalleryContainer = document.getElementById('approval-gallery-container'); const approvalModal = document.getElementById('approval-modal'); const modalTitle = document.getElementById('modal-title'); const modalCloseBtn = document.getElementById('modal-close-btn'); const modalVisual = document.getElementById('modal-visual'); const modalPlatforms = document.getElementById('modal-platforms');
        
        const getAuthHeaders = () => { const token = localStorage.getItem('jwtToken'); if (!token) return null; return { 'Authorization': `Bearer ${token}` }; };
        const setStatus = (element, message, type = 'info') => { element.className = type; element.innerHTML = message; };
        const handleLogout = () => { localStorage.removeItem('jwtToken'); localStorage.removeItem('username'); location.reload(); };

        const fetchAndRenderPlatforms = async () => {
            const container = document.getElementById('platform-selection-container'); const selectAllCheckbox = document.getElementById('select-all-platforms');
            container.innerHTML = '<p><em>Loading available platforms...</em></p>';
            const headers = getAuthHeaders(); if (!headers) { handleLogout(); return; }
            try {
                const response = await fetch(GET_PLATFORMS_URL, { headers });
                if (!response.ok) throw new Error(`Could not fetch platforms (status ${response.status}).`);
                const data = await response.json(); let platforms = data.platforms || [];
                if (!platforms.length) { container.innerHTML = '<p class="error">No platforms configured for this account.</p>'; selectAllCheckbox.disabled = true; return; }
                container.innerHTML = '';
                platforms.forEach(platform => {
                    const id = `platform-${platform}`; const wrapper = document.createElement('div'); wrapper.className = 'checkbox-wrapper';
                    const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = id; checkbox.name = 'platforms'; checkbox.value = platform; checkbox.checked = true;
                    const label = document.createElement('label'); label.htmlFor = id; label.className = 'checkbox-label'; label.innerHTML = `<span class="checkbox-custom"></span><span class="checkbox-label-text">${platform}</span>`;
                    wrapper.appendChild(checkbox); wrapper.appendChild(label); container.appendChild(wrapper);
                });
                selectAllCheckbox.disabled = false; setupSelectAllLogic();
            } catch (error) { console.error('Platform fetch error:', error); container.innerHTML = `<p class="error">${error.message || 'Failed to load platforms.'}</p>`; }
        };

        const setupSelectAllLogic = () => {
            const selectAllCheckbox = document.getElementById('select-all-platforms'); const platformCheckboxes = document.querySelectorAll('input[name="platforms"]');
            const syncSelectAllState = () => { const allChecked = Array.from(platformCheckboxes).every(cb => cb.checked); selectAllCheckbox.checked = allChecked; };
            selectAllCheckbox.addEventListener('change', () => { platformCheckboxes.forEach(cb => { cb.checked = selectAllCheckbox.checked; }); });
            platformCheckboxes.forEach(cb => { cb.addEventListener('change', syncSelectAllState); }); syncSelectAllState();
        };
        
        const uppy = new Uppy({ debug:false, autoProceed:false, restrictions:{ maxFileSize:100*1024*1024, allowedFileTypes:['image/*','video/*'], minNumberOfFiles:1 } });
        uppy.use(Dashboard, { inline:true, target:'#uppy-drag-drop-area', proudlyDisplayPoweredByUppy:false, theme:'light', height:300, hideUploadButton:true });
        uppy.use(AwsS3, { getUploadParameters: async (file) => { const response = await fetch(PRESIGNER_API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({fileName:file.name, contentType:file.type}) }); const presignData = await response.json(); return { method:'PUT', url:presignData.uploadUrl, fields:{}, headers:{'Content-Type':file.type} }; } });

        const handleLogin = async (event) => {
            event.preventDefault(); const username = document.getElementById("username").value; const password = document.getElementById("password").value;
            setStatus(statusDiv, "Logging in..."); loginBtn.disabled = true;
            try {
                const response = await fetch(LOGIN_WORKFLOW_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username, password }) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.message || `Login failed with status: ${response.status}`); }
                const data = await response.json(); localStorage.setItem('jwtToken', data.token); localStorage.setItem('username', data.username);
                await initializeUserPanel({ username: data.username });
            } catch (error) { setStatus(statusDiv, error.message, "error"); } finally { loginBtn.disabled = false; }
        };
        
        const initializeUserPanel = async (userData) => { if (!userData || !userData.username) { handleLogout(); return; } await fetchAndRenderPlatforms(); setStatus(statusDiv, "", "success"); showPanel(userData); };
        const showPanel = (userData) => { loginSection.style.display = "none"; welcomeMessage.textContent = `Welcome, ${userData.username}!`; customerPanel.style.display = "block"; };

        const handlePostSubmit = async (event) => {
            event.preventDefault(); const authHeaders = getAuthHeaders(); if (!authHeaders) { handleLogout(); return; }
            const files = uppy.getFiles(); if (files.length === 0) { postStatusDiv.innerHTML = `<div class="status-block status-error"><h4>SUBMISSION FAILED!</h4><p>Please select at least one media file.</p></div>`; return; }
            const selectedPlatforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked')).map(cb => cb.value);
            if (selectedPlatforms.length === 0) { postStatusDiv.innerHTML = `<div class="status-block status-error"><h4>SUBMISSION FAILED!</h4><p>Please select at least one platform to post to.</p></div>`; return; }
            const messages = [ "Your post has been queued. We are now processing it...", "Uploading media files to secure storage...", "AI is generating content for each platform...", "Publishing posts to selected social media channels...", "Finalizing the report, please wait a moment..." ];
            let messageIndex = 0; postStatusDiv.innerHTML = `<div class="status-block status-success"><h4>Processing...</h4><p>${messages[messageIndex]}</p></div>`;
            if (state.loadingIntervalId) clearInterval(state.loadingIntervalId);
            state.loadingIntervalId = setInterval(() => { messageIndex = (messageIndex + 1) % messages.length; postStatusDiv.innerHTML = `<div class="status-block status-success"><h4>Processing...</h4><p>${messages[messageIndex]}</p></div>`; }, 4000);
            submitPostBtn.disabled = true; backToPanelBtn.disabled = true;
            try {
                const result = await uppy.upload(); if (result.failed.length > 0) throw new Error(`Failed to upload: ${result.failed.map(f => f.name).join(', ')}`);
                const uploadedFileKeys = result.successful.map(file => new URL(file.uploadURL).pathname.substring(1)); const submissionID = crypto.randomUUID();
                const postData = { postTitle: document.getElementById('postTitle').value, postContent: document.getElementById('postContent').value, destinationLink: document.getElementById('destinationLink').value, fileKeys: uploadedFileKeys, fileUrls: uploadedFileKeys.map(key => `${R2_PUBLIC_BASE_URL}/${key}`), submissionID: submissionID, selectedPlatforms: selectedPlatforms };
                const response = await fetch(MAIN_POST_WORKFLOW_URL, { method: 'POST', headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify(postData) });
                if (!response.ok) throw new Error('Failed to submit post to n8n queue.'); pollForStatus(submissionID);
            } catch (error) { if (state.loadingIntervalId) clearInterval(state.loadingIntervalId); const errorHtml = `<div class="status-block status-error"><h4>SUBMISSION FAILED!</h4><p>${error.message}</p></div>`; postStatusDiv.innerHTML = errorHtml; submitPostBtn.disabled = false; backToPanelBtn.disabled = false; }
        };

        const pollForStatus = (submissionID) => {
            const checkStatusUrl = `${STATUS_CHECK_BASE_URL}${submissionID}`; let pollCount = 0; const maxPolls = 180;
            const intervalId = setInterval(async () => {
                pollCount++; if (pollCount > maxPolls) { clearInterval(intervalId); if (state.loadingIntervalId) clearInterval(state.loadingIntervalId); postStatusDiv.innerHTML = `<div class="status-block status-error"><h4>TIMEOUT</h4><p>The process is taking longer than expected. Please check back later or contact support.</p></div>`; return; }
                try {
                    const response = await fetch(checkStatusUrl); if (!response.ok) return;
                    const responseData = await response.json(); let result = null;
                    if (Array.isArray(responseData) && responseData.length > 0) { result = responseData[0]; } else if (typeof responseData === 'object' && responseData !== null) { result = responseData; }
                    if (result && result.Status && result.Status !== 'processing') { clearInterval(intervalId); if (state.loadingIntervalId) { clearInterval(state.loadingIntervalId); state.loadingIntervalId = null; } showFinalResult(result); }
                } catch (error) { console.error('Polling error:', error); clearInterval(intervalId); if (state.loadingIntervalId) { clearInterval(state.loadingIntervalId); state.loadingIntervalId = null; } }
            }, 5000);
        };
        
        const showFinalResult = (result) => {
            const isOverallSuccess = result.Status === 'completed'; const successIcon = `<svg class="status-icon icon-success" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`; const errorIcon = `<svg class="status-icon icon-error" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`; let finalHtml = '';
            try {
                const platformResults = typeof result.Results === 'string' ? JSON.parse(result.Results) : result.Results;
                if (Array.isArray(platformResults)) {
                    let listItems = ''; platformResults.forEach(platform => { const icon = platform.status === 'success' ? successIcon : errorIcon; listItems += `<li>${icon} ${platform.platform}: ${platform.status}</li>`; });
                    finalHtml = `<div class="status-block ${isOverallSuccess ? 'status-success' : 'status-error'}"><h4>Post Processing Complete!</h4><ul>${listItems}</ul></div>`;
                } else if (typeof platformResults === 'object' && platformResults !== null && platformResults.error) {
                    finalHtml = `<div class="status-block status-error"><h4>SUBMISSION FAILED!</h4><p><strong>Reason:</strong> ${platformResults.message || 'An unexpected error occurred.'}</p></div>`;
                } else { finalHtml = `<div class="status-block status-error"><h4>Error</h4><p>The results could not be displayed.</p></div>`; }
            } catch (e) { console.error("Error processing final result:", e); finalHtml = `<div class="status-block status-error"><h4>Error</h4><p>An error occurred while displaying the results.</p></div>`; }
            postStatusDiv.innerHTML = finalHtml; submitPostBtn.style.display = 'none'; backToPanelBtn.textContent = 'Create Another Post'; backToPanelBtn.disabled = false;
        };

        const resetPostForm = () => { if (state.loadingIntervalId) { clearInterval(state.loadingIntervalId); state.loadingIntervalId = null; } postForm.reset(); uppy.getFiles().forEach(file => uppy.removeFile(file.id)); postStatusDiv.innerHTML = ''; submitPostBtn.style.display = 'block'; submitPostBtn.disabled = false; backToPanelBtn.textContent = 'Back to Panel'; backToPanelBtn.disabled = false; };
        const showApprovalPortal = () => { customerPanel.style.display = 'none'; approvalPortalSection.style.display = 'block'; loadAndRenderApprovalGallery(); };
        const showCustomerPanel = () => { approvalPortalSection.style.display = 'none'; postFormSection.style.display = 'none'; customerPanel.style.display = 'block'; };
        
        const loadAndRenderApprovalGallery = async () => {
            approvalGalleryContainer.innerHTML = `<p class="loading-text">Loading content...</p>`;
            const headers = getAuthHeaders(); if (!headers) { handleLogout(); return; }
            try {
                const response = await fetch(GET_PENDING_POSTS_URL, { headers });
                if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                const data = await response.json(); renderGallery(data.posts);
            } catch (error) { console.error('Failed to load pending posts:', error); approvalGalleryContainer.innerHTML = `<p class="error loading-text">${error.message}</p>`; }
        };

        const renderGallery = (posts) => {
            approvalGalleryContainer.innerHTML = ''; state.pendingPosts = posts;
            if (!posts || posts.length === 0) { approvalGalleryContainer.innerHTML = `<p class="empty-text">There is no content awaiting your approval. Great job!</p>`; return; }
            posts.forEach(post => {
                const card = document.createElement('div'); card.className = 'gallery-card'; card.dataset.postId = post.postId;
                card.innerHTML = `<img src="${post.mainVisualUrl}" alt="${post.ideaText.substring(0, 50)}"><div class="gallery-card-content"><p>${post.ideaText}</p></div>`;
                card.addEventListener('click', () => openApprovalModal(post.postId));
                approvalGalleryContainer.appendChild(card);
            });
        };
        
        const openApprovalModal = (postId) => {
            const post = state.pendingPosts.find(p => p.postId === postId);
            if (!post) { console.error("Post not found!"); return; }
            modalTitle.textContent = post.ideaText; modalVisual.src = post.mainVisualUrl; modalPlatforms.innerHTML = '';
            post.platformDetails.forEach((platform, index) => {
                const item = document.createElement('div');
                item.className = 'accordion-item'; if (index === 0) { item.classList.add('active'); }
                item.innerHTML = `
                    <div class="accordion-header"><span>${platform.platform.charAt(0).toUpperCase() + platform.platform.slice(1)}</span></div>
                    <div class="accordion-content">
                        <div class="content-section"><h5>Caption</h5><div class="content-text">${platform.caption}</div></div>
                        ${platform.hashtags ? `<div class="content-section"><h5>Hashtags</h5><div class="content-hashtags">${platform.hashtags}</div></div>` : ''}
                        <div class="approval-buttons">
                            <button class="btn-decision btn-reject" data-post-id="${postId}" data-platform="${platform.platform}" data-decision="rejected">❌ Reject</button>
                            <button class="btn-decision btn-approve" data-post-id="${postId}" data-platform="${platform.platform}" data-decision="approved">✅ Approve</button>
                        </div>
                    </div>`;
                modalPlatforms.appendChild(item);
            });
            modalPlatforms.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const activeItem = modalPlatforms.querySelector('.accordion-item.active');
                    const clickedItem = header.parentElement;
                    if (activeItem && activeItem !== clickedItem) { activeItem.classList.remove('active'); }
                    clickedItem.classList.toggle('active');
                });
            });
            modalPlatforms.querySelectorAll('.btn-decision').forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetButton = e.currentTarget;
                    const { postId, platform, decision } = targetButton.dataset;
                    const parent = targetButton.parentElement;
                    parent.querySelectorAll('.btn-decision').forEach(btn => { btn.classList.remove('approved', 'rejected'); btn.classList.add('disabled'); });
                    targetButton.classList.remove('disabled'); targetButton.classList.add(decision);
                    console.log(`Decision Recorded (but not sent yet): PostID=${postId}, Platform=${platform}, Decision=${decision}`);
                });
            });
            approvalModal.classList.add('active');
        };

        const closeApprovalModal = () => { approvalModal.classList.remove('active'); };

        loginForm.addEventListener('submit', handleLogin);
        postForm.addEventListener('submit', handlePostSubmit);
        logoutBtn.addEventListener('click', handleLogout);
        showFormBtn.addEventListener('click', () => { resetPostForm(); customerPanel.style.display = 'none'; postFormSection.style.display = 'block'; });
        backToPanelBtn.addEventListener('click', () => { const isResultState = backToPanelBtn.textContent === 'Create Another Post'; if (isResultState) { resetPostForm(); } else { postFormSection.style.display = 'none'; customerPanel.style.display = 'block'; } });
        showApprovalPortalBtn.addEventListener('click', showApprovalPortal);
        backToPanelFromApprovalBtn.addEventListener('click', showCustomerPanel);
        modalCloseBtn.addEventListener('click', closeApprovalModal);
        approvalModal.addEventListener('click', (event) => { if (event.target === approvalModal) { closeApprovalModal(); } });

        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('jwtToken');
            const username = localStorage.getItem('username');
            if (token && username) {
                initializeUserPanel({ username: username });
            }
        });
    </script>
</body>
</html>
