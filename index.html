<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SynqBrand Müşteri Portalı</title>
    <link href="https://releases.transloadit.com/uppy/v3.3.1/uppy.min.css" rel="stylesheet">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 1rem; box-sizing: border-box; }
        .container { background: white; padding: 2rem 2.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 900px; text-align: center; }
        h1, h2 { color: #1c1e21; margin-top: 0; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; text-align: left; }
        label { display: block; margin-bottom: 0.5rem; color: #606770; font-weight: 600; }
        label.required::after { content: ' *'; color: #d9534f; }
        input[type="text"], input[type="password"], textarea { width: 100%; padding: 0.8rem; border: 1px solid #dddfe2; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        textarea { resize: vertical; min-height: 120px; }
        #status, #publish-status { margin-top: 1.5rem; font-weight: bold; min-height: 20px; }
        #post-status { margin-top: 1.5rem; text-align: left; min-height: 20px; line-height: 1.6; }
        .error { color: #d9534f; }
        .success { color: #5cb85c; }
        #uppy-drag-drop-area .uppy-Dashboard-inner { border: 2px dashed #dddfe2; }
        .btn-primary, .btn-secondary { width: 100%; padding: 0.8rem; border-radius: 6px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: all 0.2s ease-in-out; margin-top: 1rem; border: 2px solid; background-color: transparent; }
        .btn-primary { border-color: #4A90E2; color: #4A90E2; }
        .btn-primary:not(:disabled):hover { background-color: #4A90E2; color: white; }
        .btn-secondary { border-color: #6c757d; color: #6c757d; }
        .btn-secondary:not(:disabled):hover { background-color: #6c757d; color: white; }
        .btn-primary:disabled, .btn-secondary:disabled { border-color: #ccc; color: #ccc; background-color: #f8f8f8; cursor: not-allowed; }
        .panel-buttons { display: flex; flex-direction: column; gap: 0.5rem; }
        .status-block { border: 1px solid; border-radius: 8px; padding: 1.25rem; margin-top: 1rem; }
        .status-block h4 { margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem; font-weight: 600; }
        .status-block p { margin: 0; line-height: 1.5; }
        .status-block ul { list-style-type: none; padding: 0; margin: 0; }
        .status-block li { display: flex; align-items: center; padding: 0.4rem 0; }
        .platform-options { display: flex; flex-direction: column; gap: 0.5rem; }
        .checkbox-wrapper { display: inline-flex; align-items: center; cursor: pointer; user-select: none; }
        .checkbox-wrapper input[type="checkbox"] { display: none; }
        .checkbox-wrapper .checkbox-label { display: flex; align-items: center; }
        .checkbox-wrapper .checkbox-custom { width: 20px; height: 20px; border: 2px solid #dddfe2; border-radius: 4px; margin-right: 10px; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .checkbox-wrapper .checkbox-label-text { font-weight: 500; color: #333; }
        .checkbox-wrapper input[type="checkbox"]:checked + .checkbox-label .checkbox-custom { background-color: #4A90E2; border-color: #4A90E2; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23fff' d='M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: center; background-size: 60%; }
        .select-all-wrapper { padding-bottom: 1rem; border-bottom: 1px solid #eee; margin-bottom: 1rem; }
        .select-all-wrapper .checkbox-label-text { font-weight: 700; }
        #platform-selection-container { display: flex; flex-wrap: wrap; gap: 1.5rem; padding-top: 0.5rem; }

        /* LİSTE GÖRÜNÜMÜ STİLLERİ */
        #approval-gallery-container { display: flex; flex-direction: column; gap: 1rem; margin-top: 2rem; margin-bottom: 2rem; text-align: left; }
        .post-list-item { display: flex; align-items: center; background-color: #fff; border: 1px solid #dddfe2; border-radius: 8px; padding: 1rem; transition: transform 0.2s ease, box-shadow 0.2s ease, border-left-width 0.3s ease; border-left: 5px solid transparent; }
        .post-list-item:not(.processed) { cursor: pointer; }
        .post-list-item:not(.processed):hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .post-list-item-visual { width: 120px; height: 120px; margin-right: 1.5rem; border-radius: 6px; object-fit: cover; background-color: #f0f2f5; flex-shrink: 0; }
        .post-list-item-content { flex-grow: 1; position: relative; }
        .post-list-item-label { font-size: 0.8rem; font-weight: 600; color: #606770; margin-bottom: 0.25rem; text-transform: uppercase; }
        .post-list-item-title { font-size: 1.2rem; font-weight: 700; color: #1c1e21; margin: 0; line-height: 1.4; }
        .loading-text, .empty-text { text-align: center; color: #606770; padding: 3rem 0; font-size: 1.1rem; }
        
        /* İŞLENMİŞ GÖNDERİ STİLİ */
        .post-list-item.processed { background-color: #f8f9fa; opacity: 0.7; cursor: not-allowed; }
        .processed-tag { position: absolute; top: -5px; right: 0; background-color: #6c757d; color: white; font-size: 0.7rem; font-weight: 700; padding: 0.2rem 0.5rem; border-radius: 12px; }

        /* MODAL STİLLERİ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; padding: 1rem; box-sizing: border-box; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: white; border-radius: 8px; width: 100%; max-width: 700px; display: flex; flex-direction: column; max-height: 95vh; text-align: left; transform: scale(0.95); transition: transform 0.3s ease; overflow: hidden; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-header { padding: 1rem; display: flex; justify-content: flex-end; position: absolute; top: 0; right: 0; z-index: 10; }
        .modal-close-btn { background: rgba(0,0,0,0.4); border: none; font-size: 1.5rem; cursor: pointer; color: white; line-height: 1; padding: 0; width: 32px; height: 32px; border-radius: 50%; }
        .modal-body { overflow-y: auto; padding: 1.5rem; }
        .modal-visual-container { width: 100%; max-height: 450px; background-color: #f0f2f5; border-radius: 8px; overflow: hidden; margin-bottom: 1.5rem; }
        .modal-visual-container img { width: 100%; height: 100%; object-fit: cover; }
        .modal-text-content { padding: 0; }
        .modal-title { margin: 0 0 1.5rem 0; font-size: 1.5rem; line-height: 1.4; font-weight: 600; }
        .accordion-item { border-top: 1px solid #eee; }
        .accordion-item:last-child { border-bottom: 1px solid #eee; }
        .accordion-header { background: #fff; cursor: pointer; padding: 1rem 0; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 1.1rem; color: #1c1e21; }
        .accordion-header::after { content: '▼'; font-size: 0.8rem; transition: transform 0.2s ease; }
        .accordion-item.active .accordion-header::after { transform: rotate(180deg); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; }
        .accordion-item.active .accordion-content { max-height: 1000px; padding-bottom: 1.5rem; }
        .content-section { margin-bottom: 1rem; }
        .content-section h5 { margin: 0 0 0.5rem 0; font-size: 0.8rem; color: #606770; text-transform: uppercase; }
        .content-text, .content-hashtags { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 1rem; white-space: pre-wrap; line-height: 1.6; font-size: 0.95rem; }
        .content-hashtags { color: #4A90E2; word-break: break-word; }
        .approval-buttons { display: flex; gap: 1rem; margin-top: 1rem; }
        .btn-decision { flex-grow: 1; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.6rem; font-size: 0.9rem; border-width: 2px; }
        .btn-icon { width: 16px; height: 16px; stroke-width: 2.5; }
        .btn-approve { border-color: #28a745; color: #28a745; }
        .btn-approve:not(:disabled):hover { background-color: #28a745; color: white; }
        .btn-reject { border-color: #dc3545; color: #dc3545; }
        .btn-reject:not(:disabled):hover { background-color: #dc3545; color: white; }
        .btn-decision.approved { background-color: #28a745; color: white; border-color: #28a745;}
        .btn-decision.rejected { background-color: #dc3545; color: white; border-color: #dc3545;}
        .btn-decision:disabled { border-color: #ccc !important; color: #999 !important; background-color: #f5f5f5 !important; cursor: not-allowed; opacity: 0.7; }
        .modal-footer { padding: 1rem 2rem; border-top: 1px solid #eee; display: flex; justify-content: flex-end; align-items: center; gap: 1rem; background-color: #f8f9fa; }
        .modal-footer .btn-primary, .modal-footer .btn-secondary { width: auto; font-size: 1rem; padding: 0.7rem 1.5rem; margin-top: 0; }
        .modal-status-text { margin-right: auto; font-weight: 600; font-size: 0.9rem; }
        .modal-status-text.error { color: #dc3545; }
        .modal-status-text.success { color: #28a745; }

        /* YAYINLAMA BİLDİRİMİ STİLİ */
        #publish-status .processing { padding: 1rem; font-size: 1.1rem; font-weight: 600; color: #004085; background-color: #e7f5ff; border: 1px solid #b3d9ff; border-radius: 6px; display: flex; align-items: center; justify-content: center; gap: 0.75rem; }
        .spinner-border { display: inline-block; width: 1.5rem; height: 1.5rem; vertical-align: text-bottom; border: 0.2em solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spinner-border .75s linear infinite; }
        @keyframes spinner-border { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login, Panel, Post Form sections -->
        <div id="login-section"><h1>Portal Login</h1><form id="login-form"><div class="form-group"><label for="username">Username</label><input type="text" id="username" required></div><div class="form-group"><label for="password">Password</label><input type="password" id="password" required></div><button type="submit" id="login-btn" class="btn-primary">Log In</button></form><div id="status"></div></div>
        <div id="customer-panel" style="display:none;"><h1>Customer Panel</h1><p id="welcome-message"></p><div class="panel-buttons"><button id="show-form-btn" class="btn-primary">Create New Post</button><button id="show-approval-portal-btn" class="btn-primary">Pending Monthly Posts</button><button id="logout-btn" class="btn-secondary">Log Out</button></div></div>
        <div id="post-form-section" style="display:none;"><h2>Create New Post</h2><form id="post-form"><div class="form-group"><label for="postTitle" class="required">Title</label><input type="text" id="postTitle" required></div><div class="form-group"><label for="postContent" class="required">Content / Caption</label><textarea id="postContent" required></textarea></div><div class="form-group"><label for="destinationLink">Destination Link</label><input type="text" id="destinationLink" placeholder="https://example.com"></div><div class="form-group"><label class="required">Media Files</label><div id="uppy-drag-drop-area"></div></div><div class="form-group"><label class="required">Select Platforms to Post</label><div class="platform-options"><div class="checkbox-wrapper select-all-wrapper"><input type="checkbox" id="select-all-platforms" disabled><label for="select-all-platforms" class="checkbox-label"><span class="checkbox-custom"></span><span class="checkbox-label-text">Select / Deselect All</span></label></div><div id="platform-selection-container"><p><em>Loading available platforms...</em></p></div></div></div><button type="submit" id="submit-post-btn" class="btn-primary">Submit Post</button><button type="button" id="back-to-panel-btn" class="btn-secondary">Back to Panel</button></form><div id="post-status"></div></div>
        
        <div id="approval-portal-section" style="display:none;">
            <h2>Pending Monthly Posts</h2>
            <button type="button" id="publish-approved-btn" class="btn-primary" disabled>Send Approved Posts to Publishing Plan</button>
            <div id="publish-status"></div>
            <div id="approval-gallery-container"></div>
            <button type="button" id="back-to-panel-from-approval-btn" class="btn-secondary">Back to Panel</button>
        </div>
    </div>
    
    <!-- Modal HTML Yapısı -->
    <div class="modal-overlay" id="approval-modal">
        <div class="modal-content">
            <div class="modal-body">
                <div class="modal-visual-container">
                    <img id="modal-visual" src="" alt="Post Visual">
                </div>
                <div class="modal-text-content">
                    <h3 id="modal-title" class="modal-title"></h3>
                    <div id="modal-platforms"></div>
                </div>
            </div>
            <div class="modal-footer">
                <span id="modal-status" class="modal-status-text"></span>
                <button id="modal-cancel-btn" class="btn-secondary">Cancel</button>
                <button id="modal-save-btn" class="btn-primary">Save Changes</button>
            </div>
            <div class="modal-header">
                <button class="modal-close-btn" id="modal-close-btn">&times;</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { Uppy, Dashboard, AwsS3 } from "https://releases.transloadit.com/uppy/v3.3.1/uppy.min.mjs";

        // API URLs
        const LOGIN_WORKFLOW_URL = 'https://ops.synqbrand.com/webhook/auth/login';
        const PRESIGNER_API_URL = 'https://presigner.synqbrand.com/generate-presigned-url';
        const MAIN_POST_WORKFLOW_URL = 'https://ops.synqbrand.com/webhook/70c27eca-bdc5-46bb-897b-13c3cd27bb8d';
        const STATUS_CHECK_BASE_URL = 'https://ops.synqbrand.com/webhook/b21a7415-3fd1-41a4-905f-4718a2205852/check-status/';
        const R2_PUBLIC_BASE_URL = 'https://media.izmirarkadas.com';
        const GET_PLATFORMS_URL = 'https://ops.synqbrand.com/webhook/e3b4673c-d346-4f09-a970-052526b6646e';
        const GET_PENDING_POSTS_URL = 'https://ops.synqbrand.com/webhook/ac5496d2-7540-4db1-b7e1-a28c0e2320dc';
        const PROCESS_APPROVAL_URL = 'https://ops.synqbrand.com/webhook/ef89b9df-469d-4329-9194-6805b12a6dc5';
        const PUBLISH_APPROVED_POSTS_URL = 'https://ops.synqbrand.com/webhook/eb85bb8a-a1c4-4f0e-a50f-fc0c2afd64d0';

        let state = { loadingIntervalId: null, pendingPosts: [], modalDecisions: [] };

        // Element variables
        const loginSection = document.getElementById('login-section'); const customerPanel = document.getElementById('customer-panel'); const postFormSection = document.getElementById('post-form-section'); const loginForm = document.getElementById('login-form'); const loginBtn = document.getElementById('login-btn'); const statusDiv = document.getElementById('status'); const welcomeMessage = document.getElementById('welcome-message'); const showFormBtn = document.getElementById('show-form-btn'); const postForm = document.getElementById('post-form'); const submitPostBtn = document.getElementById('submit-post-btn'); const postStatusDiv = document.getElementById('post-status'); const backToPanelBtn = document.getElementById('back-to-panel-btn'); const logoutBtn = document.getElementById('logout-btn'); const approvalPortalSection = document.getElementById('approval-portal-section'); const showApprovalPortalBtn = document.getElementById('show-approval-portal-btn'); const backToPanelFromApprovalBtn = document.getElementById('back-to-panel-from-approval-btn'); const approvalGalleryContainer = document.getElementById('approval-gallery-container'); const approvalModal = document.getElementById('approval-modal'); const modalTitle = document.getElementById('modal-title'); const modalCloseBtn = document.getElementById('modal-close-btn'); const modalVisual = document.getElementById('modal-visual'); const modalPlatforms = document.getElementById('modal-platforms');
        const modalSaveBtn = document.getElementById('modal-save-btn'); const modalCancelBtn = document.getElementById('modal-cancel-btn'); const modalStatus = document.getElementById('modal-status');
        const publishApprovedBtn = document.getElementById('publish-approved-btn'); const publishStatus = document.getElementById('publish-status');

        const ICON_APPROVE = `<svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
        const ICON_REJECT = `<svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
        
        const getAuthHeaders = () => { const token = localStorage.getItem('jwtToken'); if (!token) return null; return { 'Authorization': `Bearer ${token}` }; };
        const setStatus = (element, message, type = 'info') => { element.className = type; element.innerHTML = message; };
        const handleLogout = () => { localStorage.removeItem('jwtToken'); localStorage.removeItem('username'); location.reload(); };

        // Approval Portal Functions
        const showApprovalPortal = () => { customerPanel.style.display = 'none'; approvalPortalSection.style.display = 'block'; publishApprovedBtn.disabled = true; publishStatus.innerHTML = ''; loadAndRenderApprovalGallery(); };
        const showCustomerPanel = () => { approvalPortalSection.style.display = 'none'; postFormSection.style.display = 'none'; customerPanel.style.display = 'block'; };
        
        const loadAndRenderApprovalGallery = async () => {
            approvalGalleryContainer.innerHTML = `<p class="loading-text">Loading content...</p>`;
            const headers = getAuthHeaders(); if (!headers) { handleLogout(); return; }
            try {
                const response = await fetch(GET_PENDING_POSTS_URL, { headers });
                if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                const data = await response.json();
                renderGallery(data.posts);
            } catch (error) { console.error('Failed to load pending posts:', error); approvalGalleryContainer.innerHTML = `<p class="error loading-text">${error.message}</p>`; }
        };

        const renderGallery = (posts) => {
            approvalGalleryContainer.innerHTML = ''; state.pendingPosts = posts;
            if (!posts || posts.length === 0) {
                approvalGalleryContainer.innerHTML = `<p class="empty-text">There is no content awaiting your approval. Great job!</p>`;
                publishApprovedBtn.style.display = 'none'; return;
            }
            publishApprovedBtn.style.display = 'block';
            posts.forEach(post => {
                const item = document.createElement('div');
                item.className = 'post-list-item';
                item.dataset.postId = post.postId;

                const isActionable = !post.status || post.status === 'Awaiting Approval';

                if (!isActionable) {
                    item.classList.add('processed');
                }

                item.innerHTML = `
                    <img src="${post.mainVisualUrl}" alt="Visual for ${post.ideaText.substring(0, 30)}" class="post-list-item-visual">
                    <div class="post-list-item-content">
                        ${!isActionable ? '<span class="processed-tag">Processed</span>' : ''}
                        <p class="post-list-item-label">POST TOPIC:</p>
                        <h4 class="post-list-item-title">${post.ideaText}</h4>
                    </div>
                `;
                
                if (isActionable) {
                    item.addEventListener('click', () => openApprovalModal(post.postId));
                }
                approvalGalleryContainer.appendChild(item);
            });
        };
        
        const checkAllDecisionsMade = (postId) => {
            const post = state.pendingPosts.find(p => p.postId === postId);
            if (!post) return;
            const totalPlatforms = post.platformDetails.length;
            const decidedPlatformsCount = state.modalDecisions.filter(d => d.postId === postId).length;
            if (totalPlatforms === decidedPlatformsCount) {
                modalSaveBtn.disabled = false;
                modalStatus.textContent = 'All decisions are made. Ready to save.';
                modalStatus.className = 'modal-status-text success';
            } else {
                modalSaveBtn.disabled = true;
                const remaining = totalPlatforms - decidedPlatformsCount;
                modalStatus.textContent = `${remaining} platform(s) still require a decision.`;
                modalStatus.className = 'modal-status-text';
            }
        };

        const openApprovalModal = (postId) => {
            const post = state.pendingPosts.find(p => p.postId === postId);
            if (!post) { console.error("Post not found!"); return; }

            state.modalDecisions = state.modalDecisions.filter(d => d.postId !== postId);
            modalSaveBtn.disabled = true;
            modalCancelBtn.disabled = false;

            modalTitle.textContent = post.ideaText;
            modalVisual.src = post.highResVisualUrl || post.mainVisualUrl;
            modalPlatforms.innerHTML = '';
            
            post.platformDetails.forEach((platform, index) => {
                const item = document.createElement('div');
                item.className = 'accordion-item';
                if (index === 0) item.classList.add('active');

                const isApproved = platform.status === 'Approved';
                const isRejected = platform.status === 'Canceled';
                const isDecided = isApproved || isRejected;
                
                item.innerHTML = `
                    <div class="accordion-header"><span>${platform.platform.charAt(0).toUpperCase() + platform.slice(1)}</span></div>
                    <div class="accordion-content">
                        <div class="content-section"><h5>Caption</h5><div class="content-text">${platform.caption}</div></div>
                        ${platform.hashtags ? `<div class="content-section"><h5>Hashtags</h5><div class="content-hashtags">${platform.hashtags}</div></div>` : ''}
                        <div class="approval-buttons">
                            <button class="btn-decision btn-reject ${isRejected ? 'rejected' : ''}" data-post-id="${postId}" data-platform="${platform.platform}" data-decision="canceled" ${isDecided ? 'disabled' : ''}>${ICON_REJECT} Reject</button>
                            <button class="btn-decision btn-approve ${isApproved ? 'approved' : ''}" data-post-id="${postId}" data-platform="${platform.platform}" data-decision="approved" ${isDecided ? 'disabled' : ''}>${ICON_APPROVE} Approve</button>
                        </div>
                    </div>`;
                modalPlatforms.appendChild(item);
            });
            
            checkAllDecisionsMade(postId);

            modalPlatforms.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    const activeItem = modalPlatforms.querySelector('.accordion-item.active');
                    const clickedItem = header.parentElement;
                    if (activeItem && activeItem !== clickedItem) activeItem.classList.remove('active');
                    clickedItem.classList.toggle('active');
                });
            });

            modalPlatforms.querySelectorAll('.btn-decision').forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetButton = e.currentTarget;
                    const { postId, platform, decision } = targetButton.dataset;
                    
                    const parent = targetButton.parentElement;
                    parent.querySelectorAll('.btn-decision').forEach(btn => btn.classList.remove('approved', 'rejected'));
                    targetButton.classList.add(decision === 'approved' ? 'approved' : 'rejected');

                    const decisionData = { postId: parseInt(postId), platform, decision };
                    state.modalDecisions = state.modalDecisions.filter(d => !(d.postId === parseInt(postId) && d.platform === platform));
                    state.modalDecisions.push(decisionData);
                    
                    checkAllDecisionsMade(parseInt(postId));
                });
            });
            approvalModal.classList.add('active');
        };

        const closeApprovalModal = () => { approvalModal.classList.remove('active'); };

        const handleSaveChanges = async () => {
            if (state.modalDecisions.length === 0) { closeApprovalModal(); return; }
            modalStatus.textContent = 'Saving...';
            modalStatus.className = 'modal-status-text';
            modalSaveBtn.disabled = true;
            modalCancelBtn.disabled = true;
            const headers = getAuthHeaders(); if (!headers) { handleLogout(); return; }

            try {
                const response = await fetch(PROCESS_APPROVAL_URL, {
                    method: 'POST', headers: { ...headers, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ decisions: state.modalDecisions })
                });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.message || 'Failed to save changes.'); }
                modalStatus.textContent = 'Saved!';
                modalStatus.className = 'modal-status-text success';
                
                setTimeout(() => {
                    closeApprovalModal();
                    loadAndRenderApprovalGallery(); 
                    publishApprovedBtn.disabled = false;
                }, 1000);

            } catch (error) {
                console.error('Save changes error:', error);
                modalStatus.textContent = `Error: ${error.message}`;
                modalStatus.className = 'modal-status-text error';
                modalSaveBtn.disabled = false;
                modalCancelBtn.disabled = false;
            }
        };

        const handlePublishApproved = async () => {
            const statusMessage = `<div class="processing"><div class="spinner-border"></div><span>Publishing process initiated...</span></div>`;
            setStatus(publishStatus, statusMessage, 'info');
            publishApprovedBtn.disabled = true;
            const headers = getAuthHeaders(); if (!headers) { handleLogout(); return; }
            try {
                const response = await fetch(PUBLISH_APPROVED_POSTS_URL, { method: 'POST', headers: headers });
                const resultText = await response.text();
                if (!response.ok) { try { const errorJson = JSON.parse(resultText); throw new Error(errorJson.message || 'An unknown error occurred.'); } catch(e) { throw new Error(resultText || `Request failed with status ${response.status}`); } }
                const result = JSON.parse(resultText);
                setStatus(publishStatus, result.message || 'Success!', 'success');
                setTimeout(() => { publishStatus.innerHTML = ''; loadAndRenderApprovalGallery(); }, 4000);
            } catch (error) { console.error('Publishing error:', error); setStatus(publishStatus, error.message, 'error'); publishApprovedBtn.disabled = false; }
        };

        // Standard Login and Manual Post functions
        const uppy = new Uppy({ debug:false, autoProceed:false, restrictions:{ maxFileSize:100*1024*1024, allowedFileTypes:['image/*','video/*'], minNumberOfFiles:1 } });
        uppy.use(Dashboard, { inline:true, target:'#uppy-drag-drop-area', proudlyDisplayPoweredByUppy:false, theme:'light', height:300, hideUploadButton:true });
        uppy.use(AwsS3, { getUploadParameters: async (file) => { const response = await fetch(PRESIGNER_API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({fileName:file.name, contentType:file.type}) }); const presignData = await response.json(); return { method:'PUT', url:presignData.uploadUrl, fields:{}, headers:{'Content-Type':file.type} }; } });
        
        const handleLogin = async (event) => {
            event.preventDefault(); const username = document.getElementById("username").value; const password = document.getElementById("password").value;
            setStatus(statusDiv, "Logging in..."); loginBtn.disabled = true;
            try {
                const response = await fetch(LOGIN_WORKFLOW_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ username, password }) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(errorData.message || `Login failed with status: ${response.status}`); }
                const data = await response.json(); localStorage.setItem('jwtToken', data.token); localStorage.setItem('username', data.username);
                await initializeUserPanel({ username: data.username });
            } catch (error) { setStatus(statusDiv, error.message, "error"); } finally { loginBtn.disabled = false; }
        };
        
        const initializeUserPanel = async (userData) => { if (!userData || !userData.username) { handleLogout(); return; } await fetchAndRenderPlatforms(); setStatus(statusDiv, "", "success"); showPanel(userData); };
        
        const showPanel = (userData) => { loginSection.style.display = "none"; welcomeMessage.textContent = `Welcome, ${userData.username}!`; customerPanel.style.display = "block"; };
        
        const handlePostSubmit = async (event) => {
            event.preventDefault(); const authHeaders = getAuthHeaders(); if (!authHeaders) { handleLogout(); return; }
            const files = uppy.getFiles(); if (files.length === 0) { postStatusDiv.innerHTML = `<div class="status-block status-error"><h4>SUBMISSION FAILED!</h4><p>Please select at least one media file.</p></div>`; return; }
            const selectedPlatforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked')).map(cb => cb.value);
            if (selectedPlatforms.length === 0) { postStatusDiv.innerHTML = `<div class="status-block status-error"><h4>SUBMISSION FAILED!</h4><p>Please select at least one platform to post to.</p></div>`; return; }
            const messages = [ "Your post has been queued...", "Uploading media files...", "AI is generating content...", "Publishing posts...", "Finalizing..." ];
            let messageIndex = 0; postStatusDiv.innerHTML = `<div class="status-block status-success"><h4>Processing...</h4><p>${messages[messageIndex]}</p></div>`;
            if (state.loadingIntervalId) clearInterval(state.loadingIntervalId);
            state.loadingIntervalId = setInterval(() => { messageIndex = (messageIndex + 1) % messages.length; postStatusDiv.innerHTML = `<div class="status-block status-success"><h4>Processing...</h4><p>${messages[messageIndex]}</p></div>`; }, 4000);
            submitPostBtn.disabled = true; backToPanelBtn.disabled = true;
            try {
                const result = await uppy.upload(); if (result.failed.length > 0) throw new Error(`Failed to upload: ${result.failed.map(f => f.name).join(', ')}`);
                const uploadedFileKeys = result.successful.map(file => new URL(file.uploadURL).pathname.substring(1)); const submissionID = crypto.randomUUID();
                const postData = { postTitle: document.getElementById('postTitle').value, postContent: document.getElementById('postContent').value, destinationLink: document.getElementById('destinationLink').value, fileKeys: uploadedFileKeys, fileUrls: uploadedFileKeys.map(key => `${R2_PUBLIC_BASE_URL}/${key}`), submissionID: submissionID, selectedPlatforms: selectedPlatforms };
                const response = await fetch(MAIN_POST_WORKFLOW_URL, { method: 'POST', headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify(postData) });
                if (!response.ok) throw new Error('Failed to submit post to n8n queue.'); pollForStatus(submissionID);
            } catch (error) { if (state.loadingIntervalId) clearInterval(state.loadingIntervalId); const errorHtml = `<div class="status-block status-error"><h4>SUBMISSION FAILED!</h4><p>${error.message}</p></div>`; postStatusDiv.innerHTML = errorHtml; submitPostBtn.disabled = false; backToPanelBtn.disabled = false; }
        };

        const pollForStatus = (submissionID) => {
            const checkStatusUrl = `${STATUS_CHECK_BASE_URL}${submissionID}`; let pollCount = 0; const maxPolls = 180;
            const intervalId = setInterval(async () => {
                pollCount++; if (pollCount > maxPolls) { clearInterval(intervalId); if (state.loadingIntervalId) clearInterval(state.loadingIntervalId); postStatusDiv.innerHTML = `<div class="status-block status-error"><h4>TIMEOUT</h4><p>The process is taking longer than expected.</p></div>`; return; }
                try {
                    const response = await fetch(checkStatusUrl); if (!response.ok) return;
                    const responseData = await response.json(); let result = null;
                    if (Array.isArray(responseData) && responseData.length > 0) { result = responseData[0]; } else if (typeof responseData === 'object' && responseData !== null) { result = responseData; }
                    if (result && result.Status && result.Status !== 'processing') { clearInterval(intervalId); if (state.loadingIntervalId) { clearInterval(state.loadingIntervalId); state.loadingIntervalId = null; } showFinalResult(result); }
                } catch (error) { console.error('Polling error:', error); clearInterval(intervalId); if (state.loadingIntervalId) { clearInterval(state.loadingIntervalId); state.loadingIntervalId = null; } }
            }, 5000);
        };
        
        const showFinalResult = (result) => {
            const isOverallSuccess = result.Status === 'completed'; const successIcon = `<svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`; const errorIcon = `<svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`; let finalHtml = '';
            try {
                const platformResults = typeof result.Results === 'string' ? JSON.parse(result.Results) : result.Results;
                if (Array.isArray(platformResults)) {
                    let listItems = ''; platformResults.forEach(platform => { const icon = platform.status === 'success' ? successIcon : errorIcon; listItems += `<li>${icon} ${platform.platform}: ${platform.status}</li>`; });
                    finalHtml = `<div class="status-block ${isOverallSuccess ? 'status-success' : 'status-error'}"><h4>Post Processing Complete!</h4><ul>${listItems}</ul></div>`;
                } else if (typeof platformResults === 'object' && platformResults !== null && platformResults.error) {
                    finalHtml = `<div class="status-block status-error"><h4>SUBMISSION FAILED!</h4><p><strong>Reason:</strong> ${platformResults.message || 'An unexpected error occurred.'}</p></div>`;
                } else { finalHtml = `<div class="status-block status-error"><h4>Error</h4><p>The results could not be displayed.</p></div>`; }
            } catch (e) { console.error("Error processing final result:", e); finalHtml = `<div class="status-block status-error"><h4>Error</h4><p>An error occurred while displaying the results.</p></div>`; }
            postStatusDiv.innerHTML = finalHtml; submitPostBtn.style.display = 'none'; backToPanelBtn.textContent = 'Create Another Post'; backToPanelBtn.disabled = false;
        };

        const resetPostForm = () => { if (state.loadingIntervalId) { clearInterval(state.loadingIntervalId); state.loadingIntervalId = null; } postForm.reset(); uppy.getFiles().forEach(file => uppy.removeFile(file.id)); postStatusDiv.innerHTML = ''; submitPostBtn.style.display = 'block'; submitPostBtn.disabled = false; backToPanelBtn.textContent = 'Back to Panel'; backToPanelBtn.disabled = false; };
        
        const fetchAndRenderPlatforms = async () => {
            const container = document.getElementById('platform-selection-container'); const selectAllCheckbox = document.getElementById('select-all-platforms');
            container.innerHTML = '<p><em>Loading available platforms...</em></p>';
            const headers = getAuthHeaders(); if (!headers) { handleLogout(); return; }
            try {
                const response = await fetch(GET_PLATFORMS_URL, { headers });
                if (!response.ok) throw new Error(`Could not fetch platforms (status ${response.status}).`);
                const data = await response.json(); let platforms = data.platforms || [];
                if (!platforms.length) { container.innerHTML = '<p class="error">No platforms configured for this account.</p>'; selectAllCheckbox.disabled = true; return; }
                container.innerHTML = '';
                platforms.forEach(platform => {
                    const id = `platform-${platform}`; const wrapper = document.createElement('div'); wrapper.className = 'checkbox-wrapper';
                    const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = id; checkbox.name = 'platforms'; checkbox.value = platform; checkbox.checked = true;
                    const label = document.createElement('label'); label.htmlFor = id; label.className = 'checkbox-label'; label.innerHTML = `<span class="checkbox-custom"></span><span class="checkbox-label-text">${platform.charAt(0).toUpperCase() + platform.slice(1)}</span>`;
                    wrapper.appendChild(checkbox); wrapper.appendChild(label); container.appendChild(wrapper);
                });
                selectAllCheckbox.disabled = false; setupSelectAllLogic();
            } catch (error) { console.error('Platform fetch error:', error); container.innerHTML = `<p class="error">${error.message || 'Failed to load platforms.'}</p>`; }
        };

        const setupSelectAllLogic = () => {
            const selectAllCheckbox = document.getElementById('select-all-platforms'); const platformCheckboxes = document.querySelectorAll('input[name="platforms"]');
            const syncSelectAllState = () => { const allChecked = Array.from(platformCheckboxes).every(cb => cb.checked); selectAllCheckbox.checked = allChecked; };
            selectAllCheckbox.addEventListener('change', () => { platformCheckboxes.forEach(cb => { cb.checked = selectAllCheckbox.checked; }); });
            platformCheckboxes.forEach(cb => { cb.addEventListener('change', syncSelectAllState); }); syncSelectAllState();
        };

        // Event Listeners
        loginForm.addEventListener('submit', handleLogin);
        postForm.addEventListener('submit', handlePostSubmit);
        logoutBtn.addEventListener('click', handleLogout);
        showFormBtn.addEventListener('click', () => { resetPostForm(); customerPanel.style.display = 'none'; postFormSection.style.display = 'block'; });
        backToPanelBtn.addEventListener('click', () => { const isResultState = backToPanelBtn.textContent === 'Create Another Post'; if (isResultState) { resetPostForm(); } else { postFormSection.style.display = 'none'; customerPanel.style.display = 'block'; } });
        showApprovalPortalBtn.addEventListener('click', showApprovalPortal);
        backToPanelFromApprovalBtn.addEventListener('click', showCustomerPanel);
        modalCloseBtn.addEventListener('click', closeApprovalModal);
        approvalModal.addEventListener('click', (event) => { if (event.target === approvalModal) { closeApprovalModal(); } });
        modalSaveBtn.addEventListener('click', handleSaveChanges);
        modalCancelBtn.addEventListener('click', closeApprovalModal);
        publishApprovedBtn.addEventListener('click', handlePublishApproved);

        window.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('jwtToken'); const username = localStorage.getItem('username');
            if (token && username) {
                initializeUserPanel({ username: username });
            }
        });
    </script>
</body>
</html>
